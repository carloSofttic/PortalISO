<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard ‚Äî Plataforma ISO</title>

  <!-- Hoja de estilos espec√≠fica del dashboard -->
  <link rel="stylesheet" th:href="@{/css/dashboard.css}">
</head>

<body>

  <!-- =========================================================
       BOT√ìN MEN√ö M√ìVIL (se muestra solo en pantallas peque√±as)
       ========================================================= -->
  <button class="menu-toggle">‚ò∞</button>

  <!-- =========================================================
       LAYOUT PRINCIPAL: SIDEBAR + CONTENIDO
       ========================================================= -->
  <div class="layout">

    <!-- =====================================================
         SIDEBAR (MEN√ö LATERAL IZQUIERDO)
         ===================================================== -->
    <aside class="sidebar">
      <!-- Logo / nombre de la plataforma -->
      <div class="sidebar-logo">
        Certificaciones ISO
      </div>

      <!-- Bot√≥n para colapsar/expandir el sidebar en escritorio -->
      <button class="sidebar-collapse-btn" type="button" title="Colapsar/expandir men√∫">‚Æú</button>

      <!-- Navegaci√≥n lateral -->
      <nav class="sidebar-nav">

        <!-- ==========================================
             Opciones visibles SOLO para ADMINISTRADOR y SGI
             ========================================== -->
        <th:block th:if="${tipoUsuario == 'ADMINISTRADOR' or tipoUsuario == 'SGI'}">

          <!-- Grupo Crear archivo + submenu -->
          <div class="item-group">
            <!-- Trigger del submen√∫ -->
            <a href="javascript:void(0)" class="item submenu-toggle2">
              <span class="icon">üìù</span>
              <span class="text">Usuarios y Licencias</span>
              <span class="arrow">‚ñæ</span>
            </a>

            <!-- Submen√∫ -->
            <div class="submenu" id="submenu-crear-usuarios">

              <!-- Gesti√≥n de usuarios -->
              <a th:href="@{/admin/usuarios}" class="item">
                <span class="icon">üë•</span>
                <span class="text">Administrar usuarios</span>
              </a>

              <!-- Gesti√≥n de licencias -->
              <a href="/licencias" class="item">
                <span class="icon">üé´</span>
                <span class="text">Asignar licencias</span>
              </a>

            </div>
          
            <!-- Trigger del submen√∫ -->
            <a href="javascript:void(0)" class="item submenu-toggle3">
              <span class="icon">üìù</span>
              <span class="text">Catalogos</span>
              <span class="arrow">‚ñæ</span>
            </a>

            <!-- Submen√∫ -->
            <div class="submenu" id="submenu-crear-catalogos">

              <a href="/admin/catalogoProcesos" class="item">
                <span class="icon">üé´</span>
                <span class="text">Catalogo de procesos</span>
              </a>

              <a href="/admin/catalogoDocumentos" class="item">
                <span class="icon">üé´</span>
                <span class="text">Catalogo de documentos</span>
              </a>

            </div>
          </div>

          <a href="/licencias" class="item">
            <span class="icon">üé´</span>
            <span class="text">Producci√≥n</span>
          </a>



          <a href="#" class="item" th:classappend="${active=='admin' ? ' active' : ''}">
            <span class="icon">üõ†Ô∏è</span>
            <span class="text">L√≠der administrador</span>
          </a>

          <a href="#" class="item" th:classappend="${active=='sgi' ? ' active' : ''}">
            <span class="icon">üß©</span>
            <span class="text">L√≠der de SGI</span>
          </a>

          <a href="#" class="item" th:classappend="${active=='calidad' ? ' active' : ''}">
            <span class="icon">‚úÖ</span>
            <span class="text">L√≠der de Calidad</span>
          </a>

          <a href="#" class="item" th:classappend="${active=='rh' ? ' active' : ''}">
            <span class="icon">üë§</span>
            <span class="text">L√≠der de Recursos Humanos</span>
          </a>

          <a href="#" class="item" th:classappend="${active=='compras' ? ' active' : ''}">
            <span class="icon">üõí</span>
            <span class="text">L√≠der de Compras</span>
          </a>

          <a href="#" class="item" th:classappend="${active=='manto' ? ' active' : ''}">
            <span class="icon">üîß</span>
            <span class="text">L√≠der de Mantenimiento</span>
          </a>

          <a href="#" class="item" th:classappend="${active=='almacen' ? ' active' : ''}">
            <span class="icon">üì¶</span>
            <span class="text">L√≠der de Almac√©n</span>
          </a>

          <a href="#" class="item" th:classappend="${active=='oper' ? ' active' : ''}">
            <span class="icon">‚öôÔ∏è</span>
            <span class="text">L√≠der de Operaciones</span>
          </a>

          <a href="#" class="item" th:classappend="${active=='planeacion' ? ' active' : ''}">
            <span class="icon">üìà</span>
            <span class="text">L√≠der de Planeaci√≥n</span>
          </a>

          <a href="#" class="item" th:classappend="${active=='seg' ? ' active' : ''}">
            <span class="icon">ü¶∫</span>
            <span class="text">L√≠der de seguridad e higiene</span>
          </a>

          <a href="#" class="item" th:classappend="${active=='dev' ? ' active' : ''}">
            <span class="icon">üíª</span>
            <span class="text">L√≠der de Desarrollo</span>
          </a>

          <a href="#" class="item" th:classappend="${active=='ti' ? ' active' : ''}">
            <span class="icon">üíæ</span>
            <span class="text">L√≠der de TI</span>
          </a>

          <a href="#" class="item" th:classappend="${active=='fact' ? ' active' : ''}">
            <span class="icon">üßæ</span>
            <span class="text">L√≠der de facturaci√≥n y embarques</span>
          </a>
        </th:block>

        <!-- ==========================================
             Opciones visibles para L√çDERES (no ADMIN/SGI)
             ========================================== -->
        <th:block th:if="${tipoUsuario != 'ADMINISTRADOR' and tipoUsuario != 'SGI'}">

          <!-- Grupo Crear archivo + submenu -->
          <div class="item-group">
            <!-- Trigger del submen√∫ -->
            <a href="javascript:void(0)" class="item submenu-toggle">
              <span class="icon">üìù</span>
              <span class="text">Crear archivo</span>
              <span class="arrow">‚ñæ</span>
            </a>

            <!-- Submen√∫ -->
            <div class="submenu" id="submenu-crear-archivo">
              <a th:href="@{/procedimientos}" class="submenu-item">
                üìù Crear procedimiento
              </a>
              <a href="/archivos/formato/nuevo" class="submenu-item">
                üìù Crear formato
              </a>
              <a href="/archivos/instructivo/nuevo" class="submenu-item">
                üìù Crear instructivo
              </a>
            </div>
          </div>

          <!-- Vista de progreso personal -->
          <a href="#" class="item">
            <span class="icon">üìä</span>
            <span class="text">Mi progreso</span>
          </a>

          <!-- Documentos asignados al usuario -->
          <a href="#" class="item">
            <span class="icon">üìÅ</span>
            <span class="text">Documentos asignados</span>
          </a>

          <!-- Actividades / tareas asignadas -->
          <a href="#" class="item">
            <span class="icon">‚úÖ</span>
            <span class="text">Mis actividades</span>
          </a>

        </th:block>
      </nav>
    </aside>

    <!-- =====================================================
         SECCI√ìN PRINCIPAL (MAIN)
         ===================================================== -->
    <main class="main">

      <!-- ======================
           TOPBAR (barra superior)
           ====================== -->
      <header class="topbar">
        <!-- Lado izquierdo: t√≠tulo o breadcrumb -->
        <div class="topbar-left">
          <span class="topbar-title">Panel principal</span>
        </div>

        <!-- Lado derecho: notificaciones + usuario -->
        <div class="topbar-right">

          <!-- ===== CAMPANA DE NOTIFICACIONES ===== -->
          <div class="notifications">
            <!-- Bot√≥n campana -->
            <button class="icon-btn" type="button" title="Notificaciones">
              üîî
              <!-- Contador fijo ficticio (2) -->
              <span class="badge">2</span>
            </button>

            <!-- Panel desplegable de notificaciones -->
            <div class="notifications-panel">
              <div class="notifications-header">
                <span>Notificaciones</span>
                <span>2 nuevas</span>
              </div>

              <!-- Notificaciones ficticias mientras no hay backend real -->
              <div class="notification-item">
                <div class="notification-title">Onboarding incompleto</div>
                <div class="notification-body">
                  A√∫n tienes pasos pendientes en el proceso inicial de la compa√±√≠a.
                </div>
                <div class="notification-meta">Hace 10 min</div>
              </div>

              <div class="notification-item">
                <div class="notification-title">Nueva tarea asignada</div>
                <div class="notification-body">
                  Tienes un nuevo documento para revisar y completar.
                </div>
                <div class="notification-meta">Hace 1 hora</div>
              </div>

              <!-- Pie del panel (en un futuro podr√≠a ir a /notificaciones) -->
              <div class="notifications-footer">
                <a href="#">Ver todas</a>
              </div>
            </div>
          </div>

          <!-- ===== MEN√ö DE USUARIO (NOMBRE + ROL + DROPDOWN) ===== -->
          <div class="user-menu">
            <!-- Chip visible en el topbar -->
            <div class="user-chip">
              <span class="user-avatar">
                <!-- Inicial del usuario (primer car√°cter del username) -->
                <span th:text="${#strings.substring(vm.username,0,1)}">U</span>
              </span>
              <div class="user-info">
                <span class="user-name" th:text="${vm.username}">Usuario</span>
                <span class="user-role" th:text="${tipoUsuario}">ROL</span>
              </div>
            </div>

            <!-- Dropdown que se muestra al hacer click en el user-chip -->
            <div class="user-dropdown">
              <a href="/perfil" class="dropdown-item">Mi perfil</a>
              <a href="/configuracion" class="dropdown-item">Configuraci√≥n</a>

              <!-- Formulario de logout (POST /logout con CSRF) -->
              <form th:action="@{/logout}" method="post" class="dropdown-item logout-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <button type="submit" class="logout-btn">Cerrar sesi√≥n</button>
              </form>
            </div>
          </div>

        </div>
      </header>

      <!-- ======================
           CONTENIDO PRINCIPAL
           ====================== -->
      <div class="content-wrap">

        <!-- Mensajes de √©xito / error del servidor -->
        <div th:if="${ok}" class="alert success" th:text="${ok}"></div>
        <div th:if="${error}" class="alert error" th:text="${error}"></div>

        <!-- =========================
             CARD PRINCIPAL DASHBOARD
             ========================= -->
        <div class="card card-lg">
          <div class="title">Dashboard</div>

          <!-- Mensaje de bienvenida con usuario y rol -->
          <div class="subtitle">
            Bienvenido,
            <b th:text="${vm.username}">Usuario</b>
            ‚Äî <span th:text="${tipoUsuario}">ROL</span>
          </div>

          <!-- ==============================================
               GRID 2 COLUMNAS: COMPA√ë√çA / AVANCE ONBOARDING
               ============================================== -->
          <div class="grid-2">

            <!-- Panel de informaci√≥n de la compa√±√≠a -->
            <section class="panel">
              <h3 class="panel-title">Compa√±√≠a</h3>

              <div class="keyval">
                <span>Nombre:</span>
                <span th:text="${vm.nombreCompania ?: '‚Äî'}">‚Äî</span>
              </div>

              <div class="keyval">
                <span>ISO seleccionada:</span>
                <span class="chip chip-green" th:text="${vm.isoSeleccionada ?: '‚Äî'}">‚Äî</span>
              </div>
            </section>

            <!-- Panel de avance de onboarding -->
            <section class="panel">
              <h3 class="panel-title">Avance</h3>

              <!-- Barra de progreso -->
              <div class="progress">
                <!-- width: vm.avance% -->
                <div class="progress-bar" th:style="'width:' + ${vm.avance} + '%;'"></div>
              </div>

              <div class="progress-meta">
                <span>Onboarding</span>
                <strong th:text="${vm.avance} + '%'">0%</strong>
              </div>

              <!-- Lista de pendientes (si existen) -->
              <ul class="todo" th:if="${vm.pendientes != null and !#lists.isEmpty(vm.pendientes)}">
                <li th:each="p : ${vm.pendientes}">
                  <span class="dot"></span>
                  <span th:text="${p}">Pendiente</span>
                </li>
              </ul>

              <!-- Mensaje cuando no hay pendientes -->
              <div class="empty" th:if="${vm.pendientes == null or #lists.isEmpty(vm.pendientes)}">
                ¬°Todo listo! üéâ
              </div>

              <!-- Botones de acci√≥n relacionados al onboarding -->
              <div class="actions">
                <div class="actions-row">
                  <a class="btn" th:href="@{/onboarding}">Completar/editar Onboarding</a>
                </div>
              </div>
            </section>

          </div> <!-- /grid-2 -->

          <!-- =====================================================
               NUEVA SECCI√ìN: GR√ÅFICAS DE PENDIENTES POR TIPO
               ===================================================== -->
          <section class="metrics">
            <h3 class="metrics-title">Pendientes por tipo de documento</h3>

            <div class="metrics-grid">

              <!-- 1) Instructivos (IT) -->
              <article class="metric-card" th:with="
  itTotal=${vm.itRevisar + vm.itAprobar + vm.itRechazar},
  itPercReview=${itTotal == 0 ? 0 : vm.itRevisar * 100 / itTotal},
  itPercApprove=${itTotal == 0 ? 0 : vm.itAprobar * 100 / itTotal},
  itPercReject=${itTotal == 0 ? 0 : vm.itRechazar * 100 / itTotal}
">
                <h4 class="metric-title">Instructivos (IT)</h4>

                <div class="metric-body">
                  <div class="metric-donut">
                    <div class="metric-donut-inner">
                      <span th:text="${vm.itPorcentaje} + '%'">0%</span>
                    </div>
                  </div>

                  <div class="metric-meta">
                    <p class="metric-caption">
                      Porcentaje de IT que siguen pendientes en el flujo
                      (revisi√≥n / aprobaci√≥n / rechazo).
                    </p>
                    <ul class="metric-list">
                      <li>
                        <span class="bullet bullet-review"></span>
                        Por revisar:
                        <strong th:text="${vm.itRevisar}">0</strong>
                      </li>
                      <li>
                        <span class="bullet bullet-approve"></span>
                        Por aprobar:
                        <strong th:text="${vm.itAprobar}">0</strong>
                      </li>
                      <li>
                        <span class="bullet bullet-reject"></span>
                        Por rechazar:
                        <strong th:text="${vm.itRechazar}">0</strong>
                      </li>
                    </ul>
                  </div>
                </div>
              </article>


              <!-- 2) Procedimientos (PP) -->
              <article class="metric-card" th:with="
  ppTotal=${vm.ppRevisar + vm.ppAprobar + vm.ppRechazar},
  ppPercReview=${ppTotal == 0 ? 0 : vm.ppRevisar * 100 / ppTotal},
  ppPercApprove=${ppTotal == 0 ? 0 : vm.ppAprobar * 100 / ppTotal},
  ppPercReject=${ppTotal == 0 ? 0 : vm.ppRechazar * 100 / ppTotal}
">
                <h4 class="metric-title">Procedimientos (PP)</h4>

                <div class="metric-body">
                  <div class="metric-donut">
                    <div class="metric-donut-inner">
                      <span th:text="${vm.ppPorcentaje} + '%'">0%</span>
                    </div>
                  </div>

                  <div class="metric-meta">
                    <p class="metric-caption">
                      Procedimientos que a√∫n no han finalizado el flujo.
                    </p>
                    <ul class="metric-list">
                      <li>
                        <span class="bullet bullet-review"></span>
                        Por revisar:
                        <strong th:text="${vm.ppRevisar}">0</strong>
                      </li>
                      <li>
                        <span class="bullet bullet-approve"></span>
                        Por aprobar:
                        <strong th:text="${vm.ppAprobar}">0</strong>
                      </li>
                      <li>
                        <span class="bullet bullet-reject"></span>
                        Por rechazar:
                        <strong th:text="${vm.ppRechazar}">0</strong>
                      </li>
                    </ul>
                  </div>
                </div>
              </article>


              <!-- 3) Formatos (F) -->
              <article class="metric-card" th:with="
  fTotal=${vm.fRevisar + vm.fAprobar + vm.fRechazar},
  fPercReview=${fTotal == 0 ? 0 : vm.fRevisar * 100 / fTotal},
  fPercApprove=${fTotal == 0 ? 0 : vm.fAprobar * 100 / fTotal},
  fPercReject=${fTotal == 0 ? 0 : vm.fRechazar * 100 / fTotal}
">
                <h4 class="metric-title">Formatos (F)</h4>

                <div class="metric-body">
                  <div class="metric-donut">
                    <div class="metric-donut-inner">
                      <span th:text="${vm.fPorcentaje} + '%'">0%</span>
                    </div>
                  </div>

                  <div class="metric-meta">
                    <p class="metric-caption">
                      Formatos que siguen en proceso de revisi√≥n/aprobaci√≥n.
                    </p>
                    <ul class="metric-list">
                      <li>
                        <span class="bullet bullet-review"></span>
                        Por revisar:
                        <strong th:text="${vm.fRevisar}">0</strong>
                      </li>
                      <li>
                        <span class="bullet bullet-approve"></span>
                        Por aprobar:
                        <strong th:text="${vm.fAprobar}">0</strong>
                      </li>
                      <li>
                        <span class="bullet bullet-reject"></span>
                        Por rechazar:
                        <strong th:text="${vm.fRechazar}">0</strong>
                      </li>
                    </ul>
                  </div>
                </div>
              </article>


              <!-- 4) Avance global documentos -->
              <article class="metric-card">
                <h4 class="metric-title">Avance global documentos</h4>

                <div class="metric-body">
                  <div class="metric-donut metric-donut-global"
                    th:style="'--angle:' + ${vm.globalPorcentaje * 3.6} + 'deg;'">
                    <div class="metric-donut-inner">
                      <span th:text="${vm.globalPorcentaje} + '%'">0%</span>
                    </div>
                  </div>

                  <div class="metric-meta">
                    <p class="metric-caption">
                      Porcentaje de avance combinando instructivos, procedimientos y formatos.
                    </p>
                    <ul class="metric-list">
                      <li>
                        <span class="bullet bullet-complete"></span>
                        Avance total:
                        <strong th:text="${vm.globalPorcentaje} + '%'">0%</strong>
                      </li>
                      <li>
                        <span class="bullet bullet-pending"></span>
                        Pendientes totales:
                        <strong th:text="${
            vm.itRevisar + vm.itAprobar + vm.itRechazar +
            vm.ppRevisar + vm.ppAprobar + vm.ppRechazar +
            vm.fRevisar + vm.fAprobar + vm.fRechazar
          }">0</strong>
                      </li>
                    </ul>
                  </div>
                </div>
              </article>


            </div>
          </section>

        </div> <!-- /card -->
      </div> <!-- /content-wrap -->
    </main>
  </div>

  <!-- JS del dashboard (sidebar, men√∫s, notificaciones, toast, etc.) -->
  <script src="/js/dashboard.js"></script>
</body>

</html>